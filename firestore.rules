rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Regra para licenças - PROTEÇÃO CONTRA USO INDEVIDO
    match /licenses/{licenseKey} {
      // Qualquer um pode ler
      allow read: if true;

      // Pode criar se não existir
      allow create: if !exists(/databases/$(database)/documents/licenses/$(licenseKey));

      // Permite UPDATE em 3 casos:
      // 1. Primeira ativação (deviceFingerprint vazio)
      // 2. Admin deletando licença (status -> deleted)
      // 3. Admin atualizando campos administrativos (message, expiresAt, status)
      allow update: if
        // Caso 1: Primeira ativação (fingerprint vazio)
        (resource.data.deviceFingerprint == "" ||
         resource.data.deviceFingerprint == null ||
         !("deviceFingerprint" in resource.data))
        ||
        // Caso 2 e 3: Admin atualizando (permite mudança em campos admin)
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'deletedAt', 'message', 'messageUpdatedAt', 'expiresAt', 'notes', 'tag']));

      // Permite deletar (para revogar licenças)
      allow delete: if true;
    }

    // NOVA REGRA - Permitir escrita pública na coleção leads
    match /leads/{lead} {
      allow read: if true;  // Qualquer um pode ler
      allow create: if true;  // Qualquer um pode criar novo lead
      allow update, delete: if false;  // Ninguém pode editar/deletar (só admin via console)
    }

    // Bloquear tudo que não foi especificado
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
