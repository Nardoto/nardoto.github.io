rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Regra para licenças - PROTEÇÃO CONTRA USO INDEVIDO E PRESERVAÇÃO DE DADOS
    match /licenses/{licenseKey} {
      // Qualquer um pode ler
      allow read: if true;

      // Pode criar se não existir
      allow create: if !exists(/databases/$(database)/documents/licenses/$(licenseKey));

      // Permite UPDATE em 2 casos:
      // CASO 1: Primeira ativação pelo cliente
      // CASO 2: Admin gerenciando (não muda deviceFingerprint de licença já ativada)
      allow update: if
        // Caso 1: Cliente ativando pela primeira vez
        (
          // Fingerprint está vazio no banco
          (resource.data.deviceFingerprint == "" ||
           resource.data.deviceFingerprint == null ||
           !("deviceFingerprint" in resource.data))
          &&
          // Deve estar setando um deviceFingerprint válido
          request.resource.data.deviceFingerprint != "" &&
          request.resource.data.deviceFingerprint != null
          &&
          // Status deve mudar para 'active'
          request.resource.data.status == 'active'
          &&
          // PROTEÇÃO: Campos importantes não podem ser modificados na ativação
          // (Permite incluir no request, mas não pode modificar se já existem)
          (!("name" in resource.data) || request.resource.data.name == resource.data.name) &&
          (!("email" in resource.data) || request.resource.data.email == resource.data.email) &&
          (!("phone" in resource.data) || request.resource.data.phone == resource.data.phone) &&
          (!("username" in resource.data) || request.resource.data.username == resource.data.username) &&
          (!("password" in resource.data) || request.resource.data.password == resource.data.password) &&
          (!("type" in resource.data) || request.resource.data.type == resource.data.type) &&
          (!("plan" in resource.data) || request.resource.data.plan == resource.data.plan) &&
          (!("licenseKey" in resource.data) || request.resource.data.licenseKey == resource.data.licenseKey)
        )
        ||
        // Caso 2: Admin gerenciando (não muda deviceFingerprint de licença já ativada)
        (
          request.resource.data.deviceFingerprint == resource.data.deviceFingerprint
        );

      // Permite deletar (para revogar licenças)
      allow delete: if true;
    }

    // NOVA REGRA - Permitir escrita pública na coleção leads
    match /leads/{lead} {
      allow read: if true;  // Qualquer um pode ler
      allow create: if true;  // Qualquer um pode criar novo lead
      allow update, delete: if false;  // Ninguém pode editar/deletar (só admin via console)
    }

    // Bloquear tudo que não foi especificado
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
